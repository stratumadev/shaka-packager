# Copyright 2023 Google LLC
#
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file or at
# https://developers.google.com/open-source/licenses/bsd

name: Release

on:
  release:
    types: [published]

jobs:
  settings:
    name: Settings
    uses: ./.github/workflows/settings.yaml

  build:
    name: Build
    needs: settings
    uses: ./.github/workflows/build.yaml
    with:
      ref: refs/tags/${{ github.event.release.tag_name }}

  artifacts:
    name: Upload Artifacts
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Debug
        run: find artifacts -ls

      - name: Attach build artifacts to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading artifacts for ${{ github.event.release.tag_name }}"
          gh -R ${{ github.repository }} release upload \
            ${{ github.event.release.tag_name }} artifacts/* \
            --clobber
